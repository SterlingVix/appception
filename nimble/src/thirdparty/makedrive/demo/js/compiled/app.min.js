/*! makedrive 0.0.40 2014-10-01 */

angular.module("makedriveApp",["ui.bootstrap","makedriveApp.services","webmakerAngular.login"]),angular.module("makedriveApp").controller("editor",["$window",function($window){ace.config.set("basePath","/vendors/ace-builds/src-min"),$window.editor=ace.edit(document.getElementById("editor")),editor.setTheme("ace/theme/monokai"),editor.getSession().setMode("ace/mode/javascript")}]).controller("make",["$window","$scope","$rootScope","getList",function($window,$scope,$rootScope,Make){var prev,sh=$window.MakeDrive.fs().Shell(),Path=$window.MakeDrive.Path,fs=$window.MakeDrive.fs({manual:!0}),sync=fs.sync;$scope.mkfile=function(){$window.filerDialogs.showSaveAsDialog("Create new file","/","name",function(error,path){sh.mkdirp(Path.dirname(path),function(e){e&&console.error(e),fs.writeFile(path,$window.editor.getValue(),function(e){e&&console.error(e),$rootScope.$emit("mkfile",path),sync.request()})})})},$scope.save=function(){$rootScope.canSave&&fs.writeFile($rootScope.selectedPath,$window.editor.getValue(),function(e){e&&console.error(e),$rootScope.$emit("mkfile",$rootScope.selectedPath),sync.request(),$rootScope.canSave=!1})},$scope.rename=function(){if($rootScope.canSave){var dirname=Path.dirname($rootScope.selectedPath),basename=Path.basename($rootScope.selectedPath),path=prompt("Rename",basename),newPath=Path.join(dirname,path);null!=path&&fs.rename($rootScope.selectedPath,newPath,function(){$rootScope.$emit("mkfile",newPath),sync.request()})}},$scope.delete=function(){$rootScope.selectedPath&&Make.remove()},$rootScope.open=function(){$window.filerDialogs.showOpenDialog(!1,!1,"Open file","/","",function(e,d){fs.readFile(d[0],"utf8",function(e,data){e||($window.editor.setValue(data),prev=jQuery.jstree.reference("#jstree").get_selected(),jQuery("#jstree").jstree("deselect_node",prev),jQuery("#jstree").jstree("select_node",d[0]))})})}}]).controller("clickToggle",["$scope",function($scope){$scope.toggled=!1,$scope.toggle=function(){$scope.toggled=!$scope.toggled,$("#wrapper").toggleClass("toggled")}}]).controller("init",["getList","$window","$scope","param","$rootScope",function(Make,$window,$scope,param,$rootScope){var fs=$window.MakeDrive.fs({manual:!0}),sync=($window.MakeDrive.fs().Shell(),fs.sync);sync.on("connected",function(){Make.getListing(),console.log("server has connected")}),sync.on("syncing",function(){console.log("syncing in progress")}),sync.connect(param("makedrive")),$rootScope.$on("mkfile",function(e,path){setTimeout(function(){var prev;jQuery.jstree.reference("#jstree")&&(prev=jQuery.jstree.reference("#jstree").get_selected()),jQuery("#jstree").jstree("deselect_node",prev),jQuery("#jstree").jstree("select_node",path)},500)}),sync.on("completed",function(){Make.getListing(),$("#success").fadeIn(1e3),$("#success").fadeOut(5e3)}),sync.on("error",function(e){e.code&&e.message?e="Error code: "+e.code+" - "+e.message:e.stack?e=e.stack:e.data?e=e.data:e.error&&(e=e.error),console.error(e),$scope.error=e.stack,$("#error").fadeIn(1e3),$("#error").fadeOut(5e3)})}]),angular.module("webmakerAngular.login",[]).factory("webmakerLoginService",["$rootScope","$window",function($rootScope,$window){function apply(){$rootScope.$$phase||$rootScope.$apply()}var auth=new $window.WebmakerAuthClient;return $rootScope.login=auth.login,$rootScope.logout=auth.logout,$rootScope._user={},auth.on("login",function(user){$rootScope._user=user,apply()}),auth.on("logout",function(){$rootScope._user={},apply()}),auth.on("error",function(message,xhr){console.log("error",message,xhr)}),auth}]).controller("createUserController",["$scope","$http","$modal","webmakerLoginService",function($scope,$http,$modal,webmakerLoginService){webmakerLoginService.on("newuser",function(assertion){$modal.open({templateUrl:"/views/create-user-form.html",controller:createUserCtrl,resolve:{assertion:function(){return assertion}}})});var createUserCtrl=function($scope,$modalInstance,webmakerLoginService,assertion){$scope.form={},$scope.user={};var usernameRegex=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-]{1,20}$/;$scope.checkUsername=function(){if($scope.form.user.username){if(!usernameRegex.test($scope.form.user.username.$viewValue))return void $scope.form.user.username.$setValidity("invalid",!1);$scope.form.user.username.$setValidity("invalid",!0),$http.post(webmakerLoginService.urls.checkUsername,{username:$scope.form.user.username.$viewValue}).success(function(username){$scope.form.user.username.$setValidity("taken",!username.exists)}).error(function(){$scope.form.user.username.$setValidity("taken",!0)})}},$scope.createUser=function(){$scope.submit=!0,$scope.form.user.$valid&&$scope.form.agree&&(webmakerLoginService.createUser({assertion:assertion,user:$scope.user}),$modalInstance.close())},$scope.cancel=function(){webmakerLoginService.analytics.webmakerNewUserCancelled(),$modalInstance.dismiss("cancel")}};webmakerLoginService.verify()}]),angular.module("makedriveApp.services",[]).factory("getList",["$rootScope","$http","$window",function($rootScope,$http,$window){function getContent(data){var listing=[];return data.map(function(content,index){0!=index&&(currentPath="/"),currentPath=Path.join(currentPath||"/",content.path);var node;node="DIRECTORY"!==content.type?{text:content.path,icon:"/demo/assets/icons/document.png",id:currentPath}:{text:content.path,id:currentPath},content.contents&&(node.children=getContent(content.contents)),listing.push(node)}),listing}function openFile(){fs.stat($rootScope.selectedPath,function(e,stat){e||(!stat.isDirectory()&&$rootScope.selectedPath?($rootScope.canSave=!0,$rootScope.$apply(),fs.readFile($rootScope.selectedPath,"utf8",function(e,data){e||$window.editor.setValue(data)})):($rootScope.canSave=!1,$rootScope.$apply()))})}function createTree(data){$("#jstree").jstree({core:{multiple:!1,data:[{text:"/",state:{opened:!0,selected:!1},children:data}]}}).bind("select_node.jstree",function(e,data){$rootScope.selectedPath=Path.normalize(data.instance.get_path(data.node).join("/")),openFile()}),jQuery.jstree.reference("#jstree").refresh()}var Make={};$rootScope.canSave=!1;var currentPath,fs=$window.MakeDrive.fs({manual:!0}),sh=$window.MakeDrive.fs().Shell(),sync=fs.sync,Path=$window.MakeDrive.Path;return Make.remove=function(){fs.stat($rootScope.selectedPath,function(e,stat){stat.isDirectory()?sh.rm($rootScope.selectedPath,{recursive:!0},function(){$rootScope.selectedPath=null,$rootScope.canSave=!1,$rootScope.$apply(),sync.request("/")}):fs.unlink($rootScope.selectedPath,function(){$rootScope.selectedPath=null,$rootScope.canSave=!1,$rootScope.$apply(),sync.request()})})},Make.getListing=function(){jQuery.jstree.reference("#jstree")&&jQuery.jstree.reference("#jstree").destroy(),$http.get("/j/").success(function(data){newListing=getContent(data),createTree(newListing)})},Make}]).factory("param",["$window",function($window){return getParam=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec($window.location.href);return null==results?null:results[1]||0}}]);
//# sourceMappingURL=app.min.map